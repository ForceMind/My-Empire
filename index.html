<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>朕的天下｜My Empire v0.6</title>
<style>
  :root{
    --gold:#d4b25d; --gold-dark:#b7943e; --paper:#f6f1e7; --ink:#333;
    --card:#fff; --line:#dcdcdc; --muted:#7a7a7a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--paper);color:var(--ink);font-family:"Microsoft YaHei",system-ui,-apple-system,Segoe UI,Roboto;}
  header{padding:14px 10px;text-align:center;background:linear-gradient(#f8ead0,#f3dfb2);}
  h1{margin:0;color:#a87b0f;font-weight:900;letter-spacing:1px}
  h1 small{display:block;font-weight:600;color:#a87b0fb0}
  .wrap{max-width:1200px;margin:0 auto;padding:8px}
  .stats{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:0 2px 0 #00000008}
  .muted{color:var(--muted);font-size:.92em}
  .row{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:#f3eee1;border:1px solid var(--gold);font-size:12px}
  button{background:var(--gold);border:none;color:#fff;font-weight:800;padding:10px 14px;border-radius:8px;cursor:pointer}
  button:hover{background:var(--gold-dark)}
  .btn-ghost{background:#fff;color:#a87b0f;border:1px solid var(--gold)}
  .panel{display:grid;grid-template-columns:1.35fr .65fr;gap:10px;margin-top:10px}
  .grid-actions{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  #log{height:280px;overflow:auto;font-size:14px;line-height:1.5}
  #chart{width:100%;height:160px;background:#fff;border:1px solid var(--line);border-radius:8px}
  .section h3{margin:.2em 0 .4em}
  select, input[type="checkbox"], input[type="radio"]{transform:translateY(1px)}
  .prov-list{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .prov{border:1px solid var(--line);border-radius:10px;padding:8px;background:#fff}
  .bar{height:8px;background:#eee;border-radius:999px;overflow:hidden;margin:4px 0}
  .bar>i{display:block;height:100%;background:#a87b0f}
  .factions{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .fac{border:1px solid var(--line);border-radius:10px;padding:8px;background:#fff}
  .modal-mask{position:fixed;inset:0;background:#0006;display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
  .modal{background:#fff;border-radius:12px;max-width:760px;width:100%;padding:16px;border:1px solid var(--line)}
  .choices{display:grid;gap:8px;margin-top:8px}
  @media (max-width:1080px){.stats{grid-template-columns:repeat(3,1fr)}}
  @media (max-width:980px){.panel{grid-template-columns:1fr} .prov-list{grid-template-columns:repeat(2,1fr)} .factions{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
<header>
  <h1>朕的天下 <small>My Empire</small></h1>
</header>

<div class="wrap">
  <!-- 顶部数值 -->
  <section class="stats">
    <div class="card">
      <div class="row"><strong>年月</strong><span id="ym">开元 1 年 1 月</span></div>
      <div class="muted">每回合=1个月</div>
    </div>
    <div class="card">
      <div class="row"><strong>国库</strong><span id="treasury">1000</span></div>
      <div class="muted">税收-军费-宫廷=净现金流</div>
    </div>
    <div class="card">
      <div class="row"><strong>民心</strong><span id="happiness">80</span></div>
      <div class="muted">低于15易爆内乱</div>
    </div>
    <div class="card">
      <div class="row"><strong>军力</strong><span id="army">500</span></div>
      <div class="muted">维持费与规模相关</div>
    </div>
    <div class="card">
      <div class="row"><strong>声望</strong><span id="fame">50</span></div>
      <div class="muted">影响外交与士气</div>
    </div>
    <div class="card">
      <div class="row"><strong>帝龄/健康</strong><span id="emperor">28 / 85</span></div>
      <div class="muted">每年（1月）年龄+1；健康影响寿命</div>
    </div>
  </section>

  <!-- 主面板 -->
  <section class="panel">
    <div class="card">
      <div class="grid-actions">
        <button onclick="openSection('内政')">内政</button>
        <button onclick="openSection('军事')">军事</button>
        <button onclick="openSection('外交')">外交</button>
        <button onclick="openSection('宫廷')">宫廷/派系</button>
      </div>
      <hr>
      <div class="row">
        <div>
          <strong>政令</strong>
          <div class="muted">每月可执行一次行动/调整一次政策</div>
        </div>
        <div>
          <button class="btn-ghost" onclick="saveGame()">存档</button>
          <button class="btn-ghost" onclick="loadGame()">读档</button>
          <button class="btn-ghost" onclick="resetGame()">新档</button>
        </div>
      </div>
      <div id="sectionArea" class="section" style="margin-top:8px"></div>
      <hr>
      <div class="row">
        <button onclick="endTurn()">结束回合</button>
        <span class="muted">结束后：固定收支 → 事件/战争/派系 → 推进时间</span>
      </div>
    </div>

    <div class="card">
      <h3>月度记事</h3>
      <div id="log"></div>
      <h3 style="margin-top:10px">现金流（国库）</h3>
      <canvas id="chart"></canvas>
    </div>
  </section>

  <!-- 省域面板 -->
  <section class="card" style="margin-top:10px">
    <div class="row">
      <h3 style="margin:.2em 0">省域总览</h3>
      <div class="muted">选择省份进行定向建设、赈灾或兴学</div>
    </div>
    <div class="prov-list" id="provList"></div>
  </section>

  <!-- 派系面板 -->
  <section class="card" style="margin-top:10px">
    <div class="row"><h3 style="margin:.2em 0">朝堂派系</h3><div class="muted">≥85 过盛；≤15 过弱，可能引发变乱</div></div>
    <div class="factions" id="facList"></div>
  </section>

  <div style="margin:10px 0;text-align:right" class="muted">v0.6 派系 + 继承 + 远征</div>
</div>

<!-- 事件弹窗 -->
<div class="modal-mask" id="modalMask">
  <div class="modal">
    <div class="row">
      <h3 id="modalTitle">朝报</h3>
      <button class="btn-ghost" onclick="closeModal()">× 关闭</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script>
/* =============== 基础数据 =============== */
const $ = s=>document.querySelector(s);
const logBox = $('#log');

const provinces = [
  {id:'并州', border:true, prosperity:55, stability:68, note:'北境要冲'},
  {id:'幽州', border:true, prosperity:48, stability:62, note:'边贸繁忙'},
  {id:'雍州', border:false, prosperity:60, stability:72, note:'宗庙之地'},
  {id:'豫州', border:false, prosperity:64, stability:70, note:'沃野千里'},
  {id:'江南', border:false, prosperity:75, stability:78, note:'鱼米之乡'},
  {id:'岭南', border:true, prosperity:58, stability:65, note:'海贸门户'},
];

const frontiers = [ // 可被并入的新省
  {id:'西陲', border:true, prosperity:50, stability:55, note:'西域要道'},
  {id:'北地', border:true, prosperity:46, stability:58, note:'草原部族'},
  {id:'南海', border:true, prosperity:62, stability:60, note:'香料诸岛'},
  {id:'东夷', border:true, prosperity:54, stability:57, note:'海上诸国'},
];

const factions = {
  外戚: {val:50, desc:'皇后/宗亲势力'},
  士族: {val:55, desc:'门阀士族与清议'},
  寒门: {val:50, desc:'寒门新贵/科举士子'},
  军功: {val:50, desc:'武将与军功集团'}
};

const state = {
  year:1, month:1,
  treasury:1000, happiness:80, army:500, fame:50,
  pop:120,
  emperorAge:28, emperorHealth:85,
  policy:{tax:1, relief:false, conscription:false},
  officers:{chancellor: randomOfficer('文'), general: randomOfficer('武')},
  historyCash:[1000],
  turnActionUsed:false, gameOver:false,
  buildBuffNext:0, peaceBuffer:0, warHeat:0, reformNext:0,
  heir:null, heirsPool: genHeirs()
};

function randomOfficer(type){
  const pool = type==='文'
    ? [
      {name:'张居正', trait:'理财',  desc:'税赋效率+10%。', effects:{taxBonus:0.10}},
      {name:'王安石', trait:'变法',  desc:'改革加速，民心波动±2。', effects:{reform:1, publicShift:2}},
      {name:'刘墉',   trait:'清廉',  desc:'贪腐事件概率-30%。', effects:{antiCorrupt:0.30}},
      {name:'陶弘景', trait:'学术',  desc:'兴学成本-30%，效果+1。', effects:{academyCost:-0.3, academyUp:+1}}
    ]
    : [
      {name:'卫青', trait:'统兵', desc:'军心+5。', effects:{morale:5}},
      {name:'李靖', trait:'奇谋', desc:'突袭战法+15%胜率。', effects:{tactic:0.15}},
      {name:'岳飞', trait:'忠烈', desc:'士气+8，军力上限+100。', effects:{morale:8, armyCap:100}},
      {name:'戚继光', trait:'练兵', desc:'征兵收益+20%。', effects:{recruitBoost:0.2}}
    ];
  return pool[Math.floor(Math.random()*pool.length)];
}

/* =============== 渲染 =============== */
function clamp(x,a,b){ return Math.max(a,Math.min(b,x)); }
function rnd(a,b){ return a + Math.random()*(b-a); }

function renderTop(){
  $('#ym').textContent = `开元 ${state.year} 年 ${state.month} 月`;
  $('#treasury').textContent = Math.round(state.treasury);
  $('#happiness').textContent = clamp(state.happiness,0,100);
  $('#army').textContent = Math.max(0,Math.round(state.army));
  $('#fame').textContent = Math.round(state.fame);
  $('#emperor').textContent = `${state.emperorAge} / ${clamp(Math.round(state.emperorHealth),0,100)}`;
  renderProvinces(); renderFactions();
}

function log(msg){
  const line = document.createElement('div');
  line.innerHTML = msg;
  logBox.appendChild(line);
  logBox.scrollTop = logBox.scrollHeight;
}

function renderProvinces(){
  const box = $('#provList'); box.innerHTML='';
  provinces.forEach(p=>{
    const el = document.createElement('div'); el.className='prov';
    el.innerHTML = `
      <div class="row">
        <div><strong>${p.id}</strong> ${p.border?'<span class="tag">边境</span>':''} <span class="muted">${p.note||''}</span></div>
        <div class="muted">繁荣 ${Math.round(p.prosperity)}｜安定 ${Math.round(p.stability)}</div>
      </div>
      <div>繁荣</div>
      <div class="bar"><i style="width:${clamp(p.prosperity,0,100)}%"></i></div>
      <div>安定</div>
      <div class="bar"><i style="width:${clamp(p.stability,0,100)}%"></i></div>
    `;
    box.appendChild(el);
  });
}

function renderFactions(){
  const box = $('#facList'); box.innerHTML='';
  Object.entries(factions).forEach(([k,v])=>{
    const risk = v.val>=85 ? '（过盛）' : v.val<=15 ? '（过弱）' : '';
    const el = document.createElement('div'); el.className='fac';
    el.innerHTML = `
      <div class="row"><strong>${k}</strong><span class="muted">${Math.round(v.val)} ${risk}</span></div>
      <div class="muted">${v.desc}</div>
      <div class="bar"><i style="width:${clamp(v.val,0,100)}%"></i></div>
    `;
    box.appendChild(el);
  });
}

function toast(msg){
  const d=document.createElement('div');
  d.textContent=msg;
  d.style.cssText='position:fixed;left:50%;top:10px;transform:translateX(-50%);background:#000d;color:#fff;padding:8px 12px;border-radius:8px;z-index:99';
  document.body.appendChild(d);
  setTimeout(()=>d.remove(),1800);
}

/* =============== 版块 =============== */
function openSection(name){
  if(state.turnActionUsed){ $('#sectionArea').innerHTML = `<div class="muted">本月已执行过行动，请结束回合。</div>`; return; }
  if(name==='内政') $('#sectionArea').innerHTML = renderDomestic();
  else if(name==='军事') $('#sectionArea').innerHTML = renderMilitary();
  else if(name==='外交') $('#sectionArea').innerHTML = renderDiplomacy();
  else $('#sectionArea').innerHTML = renderCourt();
}

function provSelectHtml(id='provPick'){
  return `<select id="${id}">${provinces.map(p=>`<option value="${p.id}">${p.id}${p.border?'（边境）':''}</option>`).join('')}</select>`;
}

/* 内政 */
function renderDomestic(){
  const c = state.officers.chancellor;
  return `
    <h3>内政</h3>
    <div class="row">
      <div>税率：
        <label><input type="radio" name="tax" value="0" ${state.policy.tax===0?'checked':''}>低</label>
        <label><input type="radio" name="tax" value="1" ${state.policy.tax===1?'checked':''}>中</label>
        <label><input type="radio" name="tax" value="2" ${state.policy.tax===2?'checked':''}>高</label>
      </div>
      <div>赈灾：<label><input type="checkbox" id="relief" ${state.policy.relief?'checked':''}> 开启（-50金/月 民心+2）</label></div>
    </div>
    <hr>
    <div class="row"><div>定向建设（-120金，民心+3，来月税收+2%，繁荣+3）</div><div>${provSelectHtml()} <button onclick="actionBuild()">执行</button></div></div>
    <div class="row"><div>定向兴学（-100金${c.effects.academyCost?-30*1+'%':''}，繁荣+2${c.effects.academyUp?`（+${c.effects.academyUp}）`:''}，声望+1）</div><div>${provSelectHtml('provAcademy')} <button onclick="actionAcademy()">执行</button></div></div>
    <div class="row"><div>定向赈灾（-90金，安定+6）</div><div>${provSelectHtml('provRelief')} <button onclick="actionRelief()">执行</button></div></div>
    <div class="muted">丞相：${c.name}｜${c.trait} — ${c.desc}</div>
    <div style="margin-top:6px"><button onclick="applyDomestic()">确认税率/赈灾</button></div>
  `;
}
function applyDomestic(){
  state.policy.tax = (document.querySelector('input[name="tax"]:checked').value)|0;
  state.policy.relief = $('#relief').checked;
  // 税率影响派系：高税→士族/外戚+，寒门-；低税相反
  const delta = state.policy.tax-1;
  factions.士族.val += delta*2; factions.外戚.val += delta*1.5; factions.寒门.val -= delta*2;
  state.turnActionUsed = true;
  log(`内政：税率设为<b>${['低','中','高'][state.policy.tax]}</b>；赈灾${state.policy.relief?'开启':'关闭'}`);
}
function findProv(id){ return provinces.find(p=>p.id===id); }
function actionBuild(){
  const id = $('#provPick').value; const p = findProv(id);
  if(state.treasury<120){ alert('国库不足'); return; }
  state.treasury -= 120; state.happiness += 3; p.prosperity += 3; state.buildBuffNext += 0.02; state.turnActionUsed=true;
  factions.士族.val += 1; factions.寒门.val += 1; // 建设皆得利
  renderTop(); log(`内政：在<b>${id}</b>修渠筑路，繁荣+3，来月税收提升。`); $('#sectionArea').innerHTML='';
}
function actionAcademy(){
  const id = $('#provAcademy').value; const p = findProv(id);
  const c = state.officers.chancellor;
  const cost = Math.max(20, 100 + Math.floor(100*(c.effects.academyCost||0)));
  if(state.treasury<cost){ alert('国库不足'); return; }
  state.treasury -= cost; p.prosperity += (2 + (c.effects.academyUp||0)); state.fame += 1; state.turnActionUsed=true;
  factions.寒门.val += 3; factions.士族.val -= 1;
  renderTop(); log(`内政：在<b>${id}</b>兴学，繁荣上扬，声望+1。`); $('#sectionArea').innerHTML='';
}
function actionRelief(){
  const id = $('#provRelief').value; const p = findProv(id);
  if(state.treasury<90){ alert('国库不足'); return; }
  state.treasury -= 90; p.stability += 6; state.happiness += 2; state.turnActionUsed=true;
  factions.寒门.val += 2; factions.外戚.val -= 1;
  renderTop(); log(`内政：向<b>${id}</b>赈灾，安定+6，民心+2。`); $('#sectionArea').innerHTML='';
}

/* 军事 */
function renderMilitary(){
  const g = state.officers.general;
  const frontierList = frontiers.length? `<select id="frontPick">${frontiers.map(f=>`<option>${f.id}</option>`).join('')}</select>` : '<span class="muted">（无可远征地区）</span>';
  return `
    <h3>军事</h3>
    <div class="row">
      <div>征兵：<label><input type="checkbox" id="cons" ${state.policy.conscription?'checked':''}> 开启（+80*${1+(g.effects.recruitBoost||0)} 军力/月，民心-2，军费↑）</label></div>
      <div><button onclick="drill()">大演武（-80金，军心+5，声望+2）</button></div>
    </div>
    <div class="row">
      <div>远征外域：${frontierList}</div>
      <div><button onclick="expedition()">发兵远征（-150金，胜：并省；败：军力-120）</button></div>
    </div>
    <div class="muted">将军：${g.name}｜${g.trait} — ${g.desc}</div>
    <div style="margin-top:6px"><button onclick="applyMilitary()">确认</button></div>
  `;
}
function applyMilitary(){ state.policy.conscription = $('#cons').checked; state.turnActionUsed = true; factions.军功.val += state.policy.conscription?3:-1; log(`军事：征兵${state.policy.conscription?'开启':'关闭'}`); }
function drill(){
  if(state.treasury<80){ alert('国库不足'); return; }
  const g = state.officers.general;
  state.treasury -= 80; state.army += 20 + (g.effects.morale||0); state.fame += 2; state.happiness += 1; state.emperorHealth -= 1;
  state.turnActionUsed=true; factions.军功.val += 2;
  renderTop(); log('军事：大演武壮军心，军力上升。'); $('#sectionArea').innerHTML='';
}
function expedition(){
  if(!frontiers.length){ toast('无可远征目标'); return; }
  if(state.treasury<150){ alert('国库不足'); return; }
  const id = ($('#frontPick')||{}).value || frontiers[0].id;
  const targetIdx = frontiers.findIndex(f=>f.id===id);
  const target = frontiers[targetIdx];
  state.treasury -= 150;
  const g = state.officers.general;
  const power = state.army + state.fame*1.2 + (g.effects.morale||0)*5;
  const diff  = power - (520 + Math.random()*180);
  const winRate = clamp(0.35 + diff/900 + (g.effects.tactic||0), 0.15, 0.85);
  if(Math.random()<winRate){
    // 并省
    provinces.push(target);
    frontiers.splice(targetIdx,1);
    state.army -= 90; state.fame += 6; factions.军功.val += 6; factions.外戚.val += 2;
    log(`远征告捷！并入 <b>${target.id}</b> 为新省。`);
  }else{
    state.army -= 120; state.happiness -= 3; state.fame -= 2; factions.军功.val -= 4;
    log(`远征失利……损兵折将，百姓惶惧。`);
  }
  state.turnActionUsed = true; renderTop(); $('#sectionArea').innerHTML='';
}

/* 外交 */
function renderDiplomacy(){
  return `
    <h3>外交</h3>
    <div class="row"><div>赈济邻国（-100金，声望+6，和平期+1）</div><div><button onclick="diplomacyAid()">执行</button></div></div>
    <div class="row"><div>下战书（声望+3，下一回合战争概率↑）</div><div><button onclick="diplomacyThreat()">执行</button></div></div>
    <div class="row"><div>鼓励学术互访（-120金，来月改革红利）</div><div><button onclick="useReform()">执行</button></div></div>
  `;
}
function diplomacyAid(){ if(state.treasury<100){alert('国库不足');return;} state.treasury-=100; state.fame+=6; state.peaceBuffer+=1; state.turnActionUsed=true; factions.士族.val += 1; renderTop(); log('外交：赈济邻国，战云暂缓。'); $('#sectionArea').innerHTML=''; }
function diplomacyThreat(){ state.warHeat+=1; state.fame+=3; state.turnActionUsed=true; factions.军功.val += 2; renderTop(); log('外交：下战书示威，边境紧张。'); $('#sectionArea').innerHTML=''; }
function useReform(){ if(state.treasury<120){alert('国库不足');return;} state.treasury-=120; state.reformNext+=1; state.turnActionUsed=true; factions.寒门.val += 2; renderTop(); log('外交：学术互访，来月改革红利。'); $('#sectionArea').innerHTML=''; }

/* 宫廷/派系 + 立储 */
function renderCourt(){
  const heirStr = state.heir ? `【太子】${state.heir.name}（仁${state.heir.ren} 智${state.heir.zhi} 武${state.heir.wu} 政${state.heir.zheng} 忠${state.heir.loyal}）`
                             : '未立储';
  return `
    <h3>宫廷/派系</h3>
    <div class="row"><div>丞相：<span class="tag">${state.officers.chancellor.name}｜${state.officers.chancellor.trait}</span></div><div><button onclick="changeOfficer('chancellor')">任免</button></div></div>
    <div class="row"><div>将军：<span class="tag">${state.officers.general.name}｜${state.officers.general.trait}</span></div><div><button onclick="changeOfficer('general')">任免</button></div></div>
    <div class="row"><div>普天同庆（-60金，民心+4）</div><div><button onclick="reward()">赏赐</button></div></div>
    <hr>
    <div class="row"><div>派系操作：</div>
      <div>
        <select id="facPick">${Object.keys(factions).map(k=>`<option>${k}</option>`).join('')}</select>
        <button onclick="pacify()">安抚（-60金，该派+6，其他-2，民心+1）</button>
        <button onclick="suppress()">打压（声望-1，该派-8，军功+2）</button>
        <button onclick="ally()">拉拢（-40金，该派+4，另选一派-3）</button>
      </div>
    </div>
    <hr>
    <div class="row"><div>储位：${heirStr}</div><div><button onclick="openHeirModal()">立储</button></div></div>
  `;
}
function changeOfficer(key){
  const neo = randomOfficer(key==='chancellor'?'文':'武');
  state.officers[key]=neo; state.turnActionUsed=true; 
  // 任免：士族偏向丞相，军功偏向将军
  if(key==='chancellor'){ factions.士族.val += 2; }
  else { factions.军功.val += 2; }
  log(`宫廷：改任${key==='chancellor'?'丞相':'将军'} <b>${neo.name}</b>（${neo.trait}）`); $('#sectionArea').innerHTML='';
}
function reward(){ if(state.treasury<60){alert('国库不足');return;} state.treasury-=60; state.happiness+=4; state.turnActionUsed=true; factions.外戚.val += 2; renderTop(); log('宫廷：普天同庆，百官与民皆欢。'); $('#sectionArea').innerHTML=''; }

function pacify(){
  const k = ($('#facPick')||{}).value; if(!k) return;
  if(state.treasury<60){alert('国库不足');return;}
  state.treasury-=60; factions[k].val += 6;
  Object.keys(factions).forEach(x=>{ if(x!==k) factions[x].val -= 2; });
  state.happiness += 1; state.turnActionUsed=true; renderTop(); log(`派系：安抚<b>${k}</b>。`);
  $('#sectionArea').innerHTML='';
}
function suppress(){
  const k = ($('#facPick')||{}).value; if(!k) return;
  factions[k].val -= 8; factions.军功.val += 2; state.fame -= 1; state.turnActionUsed=true; renderTop(); log(`派系：打压<b>${k}</b>。`);
  $('#sectionArea').innerHTML='';
}
function ally(){
  const k = ($('#facPick')||{}).value; if(!k) return;
  if(state.treasury<40){alert('国库不足');return;}
  state.treasury-=40; factions[k].val += 4;
  // 另随机一派 -3
  const others = Object.keys(factions).filter(x=>x!==k);
  factions[others[Math.floor(Math.random()*others.length)]].val -= 3;
  state.turnActionUsed=true; renderTop(); log(`派系：拉拢<b>${k}</b>，他派不满。`);
  $('#sectionArea').innerHTML='';
}

/* =============== 立储与继承 =============== */
function genHeirs(){
  const names = ['弘历','承祺','景曜','子昂','延祚','绍衡','仲宣','元修'];
  const pool = [];
  for(let i=0;i<3;i++){
    pool.push({
      name:names[Math.floor(Math.random()*names.length)] + (Math.random()<0.5?'':'·卿'),
      ren:randInt(3,9), zhi:randInt(3,9), wu:randInt(3,9), zheng:randInt(3,9),
      loyal:randInt(40,95)
    });
  }
  return pool;
}
function randInt(a,b){ return Math.floor(a+Math.random()*(b-a+1)); }

function openHeirModal(){
  const body = `
    <div class="muted">从三名皇子中选定太子（仅展示一次塞选，请慎重）</div>
    <div class="choices">
      ${state.heirsPool.map((h,i)=>`<button onclick="chooseHeir(${i})">${h.name}｜仁${h.ren} 智${h.zhi} 武${h.wu} 政${h.zheng} 忠${h.loyal}</button>`).join('')}
    </div>`;
  modal('立储', body);
}
function chooseHeir(i){
  state.heir = state.heirsPool[i];
  state.heirsPool = genHeirs(); // 下次再开也是新一批候选
  log(`立储：册立<b>${state.heir.name}</b>为太子。`);
  closeModal(); state.turnActionUsed = true; factions.外戚.val += 4; renderTop();
}

function trySuccession(reason){
  // 继位逻辑：太子→新帝加成
  const h = state.heir || {ren:6,zhi:6,wu:6,zheng:6,loyal:60,name:'监国王'};
  log(`— ${reason} — <b>${h.name}</b>登基继位。`);
  // 将天赋转化为基础修正
  state.happiness += Math.round((h.ren-6)*1.2);
  state.fame      += Math.round((h.zhi-6)*1.0);
  state.army      += Math.round((h.wu-6)*8);
  state.treasury  += Math.round((h.zheng-6)*60);
  // 新帝年龄/健康
  state.emperorAge = 22 + randInt(0,6);
  state.emperorHealth = 88;
  state.heir = null;
  factions.外戚.val += 6; factions.军功.val -= 2; // 外戚得势
  // 风险归零化一些
  state.gameOver=false;
}

/* =============== 回合结算 =============== */
function endTurn(){
  if(state.gameOver) return;

  // 1) 固定收支
  const baseTax = (state.pop * (8 + state.policy.tax*6));
  const taxOfficer = 1 + (state.officers.chancellor.effects.taxBonus||0);
  const buildBuff = 1 + state.buildBuffNext;
  const taxIncome = baseTax * taxOfficer * buildBuff * (1 + avgProsperity()/400);
  const reliefCost = state.policy.relief ? 50 : 0;
  const g = state.officers.general;
  const consGain = state.policy.conscription ? Math.round(80*(1+(g.effects.recruitBoost||0))) : 0;
  const consCost = state.policy.conscription ? 70 : 0;
  const armyUpkeep = Math.max(0, Math.floor(state.army*0.05)) + consCost;
  const courtCost = 30;
  const reformBonus = state.reformNext>0 ? 60 : 0;
  const cashFlow = taxIncome - armyUpkeep - courtCost - reliefCost + reformBonus;

  state.treasury += cashFlow;
  if(state.policy.relief) state.happiness += 2;
  if(state.policy.conscription){ state.army += consGain; state.happiness -= 2; }

  if(state.officers.chancellor.effects.publicShift){ state.happiness += (Math.random()<0.5?-1:1) * state.officers.chancellor.effects.publicShift; }

  // 2) 战争/灾害/普通事件
  let warProb = clamp(0.12 + state.warHeat*0.08 - state.peaceBuffer*0.06, 0.02, 0.45);
  const r = Math.random();
  let ev;
  if(r < warProb) ev = makeWarEvent();
  else if(Math.random()<0.14) ev = disasterEvent();
  else ev = randomChoiceEvent();

  openChoiceModal(ev, ()=>{
    // 3) 推进时间
    state.month++; 
    if(state.month>12){ 
      state.month=1; state.year++; 
      // 年度：帝龄+1，健康回落少许，派系自然漂移，继承判定
      state.emperorAge += 1; state.emperorHealth -= rnd(1,4);
      driftFactions();
      annualSuccessionCheck();
    }
    state.turnActionUsed=false;
    // 一次性效果衰减
    state.buildBuffNext=0; if(state.peaceBuffer>0) state.peaceBuffer--; if(state.warHeat>0) state.warHeat--; state.reformNext=0;
    // 记录现金与刷新
    state.historyCash.push(Math.round(state.treasury));
    renderTop(); drawChart(); checkEnding();
  });

  log(`收支：税收<b>+${Math.round(taxIncome)}</b>，军费<b>-${armyUpkeep}</b>，宫廷<b>-${courtCost}</b>，赈灾<b>-${reliefCost}</b>${reformBonus?`，改革<b>+${reformBonus}</b>`:''} → 净额 <b>${Math.round(cashFlow>=0?'+':'')+Math.round(cashFlow)}</b>`);
}

function avgProsperity(){ return provinces.reduce((s,p)=>s+p.prosperity,0)/provinces.length; }

function driftFactions(){
  // 自然漂移：外戚缓慢上升，军功随和平下滑，士族/寒门围绕政策震荡
  factions.外戚.val += 0.8;
  factions.军功.val += (Math.random()<0.4?-1:0);
  factions.士族.val += (state.policy.tax===2?1:state.policy.tax===0?-1:0);
  factions.寒门.val += (state.policy.tax===0?1:state.policy.tax===2?-1:0);
}

/* =============== 事件库（同前，略增几条派系/健康向） =============== */
function randomChoiceEvent(){
  const pool = EVENTS.filter(e=>!e.gate || e.gate());
  const base = pool[Math.floor(Math.random()*pool.length)];
  if(base.bindProvince){
    const pick = provinces[Math.floor(Math.random()*provinces.length)];
    return base.bindProvince(pick);
  }
  return base;
}

function disasterEvent(){
  const pick = provinces[Math.floor(Math.random()*provinces.length)];
  const kind = Math.random()<0.5?'洪涝':'旱灾';
  return {
    title:`${pick.id} ${kind}`,
    text:`${pick.id} 遭遇${kind}，田亩受损，粮价波动。`,
    choices:[
      {label:'开仓赈济（民心+4，国库-120，省安定+8）', eff:()=>{ pick.stability+=8; factions.寒门.val+=2; return {happiness:4,treasury:-120}; }},
      {label:'节度自理（民心-3，省安定-6）', eff:()=>{ pick.stability-=6; factions.士族.val+=1; return {happiness:-3}; }},
    ]
  }
}

function makeWarEvent(){
  // 选边境省
  const border = provinces.filter(p=>p.border);
  const pick = border[Math.floor(Math.random()*border.length)];
  const g = state.officers.general;
  const enemy = Math.max(260, 420 + Math.random()*250 - state.fame*1.3);
  const ours  = state.army + (g.effects.morale||0)*5;
  const advantage = ours - enemy;
  return {
    title:`${pick.id} 边境告急`,
    text:`斥候回报：敌军约 <b>${Math.round(enemy)}</b>。我军 <b>${Math.round(state.army)}</b>。战火或波及 ${pick.id} 安定。`,
    choices:[
      {
        label:'主动出击（胜：声望+6，军力-80，边省安定+6；败：军力-150，民心-6，边省安定-8）',
        eff:()=>{
          const winRate = clamp(0.45 + advantage/800 + (g.effects.tactic||0),0.15,0.85);
          if(Math.random()<winRate){ pick.stability+=6; factions.军功.val += 4; return {fame:6,army:-80 + (g.effects.morale||0)}; }
          else { pick.stability-=8; factions.军功.val -= 4; return {army:-150,happiness:-6}; }
        }
      },
      { label:'固守待援（军力-40，声望-1，民心+1，边省安定+2）', eff:()=>{ pick.stability+=2; factions.士族.val += 1; return {army:-40,fame:-1,happiness:1}; } }
    ]
  }
}

const EVENTS = [
  { title:'岁稔年丰', text:'五谷丰登，仓廪盈实。', weight:2,
    choices:[
      {label:'减免秋税（民心+6，国库-120）', eff:()=>{ factions.寒门.val+=2; return {happiness:6,treasury:-120}; }},
      {label:'储粮以备（声望+2，国库+60）', eff:()=>{ factions.士族.val+=1; return {fame:2,treasury:60}; }},
    ]
  },
  { title:'盐铁盈余', text:'国营盐铁岁入大增。', choices:[
      {label:'入库充盈（国库+140）', eff:{treasury:140}},
      {label:'减赋惠民（民心+4，声望+1，国库-40）', eff:()=>{ factions.寒门.val+=1; return {happiness:4,fame:1,treasury:-40}; }},
  ]},
  { title:'御苑秋猎', text:'秋风起，猎期至。', choices:[
      {label:'盛大围猎（声望+2，民心+1，国库-60，健康-3）', eff:()=>{ state.emperorHealth-=3; return {fame:2,happiness:1,treasury:-60}; }},
      {label:'从简小猎（军力+10，健康-1）', eff:()=>{ state.emperorHealth-=1; return {army:10}; }},
  ]},
  { title:'清修斋戒', text:'陛下于宫中清修辟谷。', choices:[
      {label:'三日而止（健康+3，声望+1）', eff:()=>{ state.emperorHealth+=3; return {fame:1}; }},
      {label:'旬日精修（健康+6，国库-30）', eff:()=>{ state.emperorHealth+=6; return {treasury:-30}; }},
  ]},
  { title:'贪墨案', text:'御史弹劾某地官吏贪墨。', gate:()=>Math.random()>(state.officers.chancellor.effects.antiCorrupt||0), choices:[
      {label:'重判籍没（声望+4，国库+80，士族-1）', eff:()=>{ factions.士族.val-=1; return {fame:4,treasury:80}; }},
      {label:'宽宥示恩（民心+5，声望-3，外戚+2）', eff:()=>{ factions.外戚.val+=2; return {happiness:5,fame:-3}; }},
  ]},
  { title:'书院兴盛', bindProvince:(p)=>({
      title:`${p.id} 书院`,
      text:`${p.id} 士子云集，欲扩建讲堂。`,
      choices:[
        {label:'拨款扩建（-80金，省繁荣+3，声望+1）', eff:()=>{ p.prosperity+=3; factions.寒门.val+=2; return {treasury:-80,fame:1}; }},
        {label:'择优扶持（省繁荣+1）', eff:()=>{ p.prosperity+=1; factions.士族.val+=1; return {}; }},
      ]
  })},
  { title:'宗亲请封', text:'宗室贵胄请加封邑。', choices:[
      {label:'从其所请（民心+1，国库-70，外戚+3）', eff:()=>{ factions.外戚.val+=3; return {happiness:1,treasury:-70}; }},
      {label:'量留薄赏（声望+1，外戚-2）', eff:()=>{ factions.外戚.val-=2; return {fame:1}; }},
  ]},
];

/* =============== 弹窗 =============== */
function modal(title, inner){ $('#modalTitle').innerHTML=title; $('#modalBody').innerHTML=inner; $('#modalMask').style.display='flex'; }
function openChoiceModal(eventObj, afterResolve){
  modal(eventObj.title || '朝报', `<div class="muted" style="margin-bottom:8px">${eventObj.text}</div>
    <div class="choices">
      ${eventObj.choices.map((c,i)=>`<button onclick="choose(${i})">${c.label}</button>`).join('')}
    </div>`);
  window.choose = (idx)=>{
    const c = eventObj.choices[idx];
    const eff = (typeof c.eff==='function') ? c.eff() : c.eff;
    applyEffects(eff);
    log(`事件「<b>${eventObj.title}</b>」选择：<i>${c.label}</i>`);
    closeModal();
    if(afterResolve) afterResolve();
  }
}
function closeModal(){ $('#modalMask').style.display='none'; }
function applyEffects(eff){
  if(!eff) return;
  state.treasury += eff.treasury||0;
  state.happiness += eff.happiness||0;
  state.army += eff.army||0;
  state.fame += eff.fame||0;
  renderTop();
}

/* =============== 结局/派系风暴/继承判定 =============== */
function checkEnding(){
  const worst = provinces.reduce((m,p)=>Math.min(m,p.stability),999);
  if(state.happiness<=0) return endGame('民心尽失，四方并起。');
  if(state.treasury<-200) return endGame('国库崩溃，群臣哗变。');
  if(state.army<=0) return endGame('兵尽矢绝，无以为守。');
  if(worst<=10) return endGame('边地烽烟不绝，省域崩坏。');

  // 派系风暴（每月检）
  Object.entries(factions).forEach(([k,v])=>{
    if(v.val>=100) v.val=100; if(v.val<=0) v.val=0;
    if(v.val>=85 && Math.random()<0.08){
      // 过盛：架空威胁
      log(`【派系过盛】${k}势大，挟制朝政。声望-2，民心-2。`);
      state.fame -= 2; state.happiness -= 2;
      if(Math.random()<0.15){
        // 小型政变
        log(`<b>— ${k}发动宫闱政变 —</b>`);
        factions[k].val -= 12; factions.军功.val += 6;
        trySuccession('宫闱政变');
      }
    }
    if(v.val<=15 && Math.random()<0.06){
      // 过弱：反噬
      log(`【派系失衡】${k}被打压过度，廷中不平。民心-1。`);
      state.happiness -= 1;
    }
  });

  // 小成就提示
  if(state.happiness>=95) toast('【盛世将临】民心如日中天！');
  if(state.fame>=90) toast('【威加海内】声望震慑四方！');
  if(state.treasury>=6000) toast('【富可敌国】金谷满仓！');
}

function annualSuccessionCheck(){
  // 年度死亡概率：年龄、健康、派系（外戚过盛+）、是否战争年（军功过盛+）
  const base = (state.emperorAge>60?0.06:0) + (state.emperorAge>70?0.06:0) + (state.emperorAge>80?0.08:0);
  const health = clamp(1 - state.emperorHealth/100, 0, 1)*0.08;
  const facRisk = (factions.外戚.val>85?0.02:0) + (factions.军功.val>85?0.02:0);
  const dieProb = clamp(base + health + facRisk, 0, 0.22);
  if(Math.random() < dieProb){
    trySuccession('大行皇帝崩');
  }
}

function endGame(reason){
  state.gameOver = true;
  log('<b>— 游戏结束 —</b> '+reason);
  alert('游戏结束：'+reason+'（可“读档”或“新档”重来）');
}

/* =============== 存档 =============== */
function saveGame(){ localStorage.setItem('myempire_v06', JSON.stringify({state,provinces,frontiers,factions})); toast('已存档'); }
function loadGame(){
  const raw = localStorage.getItem('myempire_v06'); if(!raw){ toast('无存档'); return; }
  const data = JSON.parse(raw);
  Object.assign(state, data.state);
  syncArray(provinces, data.provinces);
  syncArray(frontiers, data.frontiers||[]);
  Object.keys(factions).forEach(k=> delete factions[k]);
  Object.assign(factions, data.factions||{});
  renderTop(); drawChart(); log('读取存档成功。');
}
function syncArray(arr, src){ arr.splice(0,arr.length,...src); }
function resetGame(){
  if(!confirm('开启新档？当前进度将被覆盖')) return;
  location.reload();
}

/* =============== 折线图 =============== */
const ctx = document.querySelector('#chart').getContext('2d');
function drawChart(){
  const W = ctx.canvas.width = ctx.canvas.clientWidth;
  const H = ctx.canvas.height = ctx.canvas.clientHeight;
  ctx.clearRect(0,0,W,H);
  const data = state.historyCash.slice(-60);
  if(data.length<2) return;
  const min = Math.min(...data), max = Math.max(...data);
  const pad = 12; const xStep = (W-2*pad)/(data.length-1);
  const y = v => H - pad - ((v-min)/(max-min||1))*(H-2*pad);
  ctx.lineWidth = 2; ctx.strokeStyle = '#a87b0f'; ctx.beginPath();
  data.forEach((v,i)=>{ const px=pad+i+xStep*i, py=y(v); if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py); }); ctx.stroke();
  ctx.strokeStyle='#ddd'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(pad,y(0)); ctx.lineTo(W-pad,y(0)); ctx.stroke();
}

/* =============== 启动 =============== */
function boot(){
  renderTop(); drawChart(); log('游戏开始：朕登大宝，百官来贺。');
  openChoiceModal({
    title:'登基大典',
    text:'百官山呼万岁，万民齐贺大统。',
    choices:[
      {label:'普天同庆（-80金，民心+6，声望+2）', eff:{treasury:-80,happiness:6,fame:2}},
      {label:'从简以德（-0金，声望+3）', eff:{fame:3}},
    ]
  }, ()=>{});
}
window.addEventListener('load', boot);
</script>
</body>
</html>
